# Импорт ГАР в Postgresql
## Что такое ГАР
**Государственный адресный реестр (ГАР)** – это государственный базовый информационный ресурс, содержащий сведения об адресах и о реквизитах документов о присвоении, об изменении, аннулировании адреса.

ГАР формируется Федеральной налоговой службой России и с августа 2021 года является развитием ФИАС. Сначала был **КЛАДР** - Классификатор адресов РФ, затем **ФИАС** - Федеральная информационная адресная система, и теперь **ГАР**

На сайте ФНС есть онлайн сервис для [поиска](https://fias.nalog.ru/Search) адресов в базе ГАР с точностью до дома

Базу ГАР находится в свободном доступе для [скачивания](https://fias.nalog.ru/Updates) в формате XML. Размер архива базы 33Гб.

Разобраться в структуре базы для выгрузке можно по [схеме данных](https://fias.nalog.ru/docs/gar_schemas.zip)

## Зачем импортировать ГАР в Postgresql
Именно в Postgresql конечно не обязательно - тут дело вкуса, какую БД выбрать, но, в общем, причин иметь собственную БД адресов как минимум две
1. ГАР содержит больше информации, чем выдает поисковый сервис ФНС: в ГАР дополнительно содержится информация о номерах квартирах, комнатах, земельных участках и парковочных местах
2. На основе БД можно реализовать собственный инструмент поиска адреса по административному и мунициальному делению
Разобраться в структуре базы для выгрузке можно по [схеме данных](https://fias.nalog.ru/docs/gar_schemas.zip)

## Зачем импортировать ГАР в Postgresql
Именно в Postgresql конечно не обязательно - тут дело вкуса, какую БД выбрать, но, в общем, причин иметь собственную БД адресов как минимум две
1. ГАР содержит больше информации, чем выдает поисковый сервис ФНС: в ГАР дополнительно содержится информация о номерах квартирах, комнатах, земельных участках и парковочных местах
2. На основе БД можно реализовать собственный инструмент поиска адреса по административному и мунициальному делению

В качестве примера решения второй задачи был реализован [этот сервис](https://card-sfera.online/gar/)

## Требования и результаты к поисковой БД адресов
**Требования**
1. **Поиск адреса должен выполняться по нечеткому запросу.** На странице поиска адреса сайта ФНС качественно реализован поиск по нечеткому запросу. Например для поисковой строки *"ростов нагибина 40а"* сервис выдаст результат поиска *"Ростовская область, город Ростов-на-Дону, проспект Михаила Нагибина, дом 40а"*. 
2. **Поиск по БД должен быть быстрый**. Архив базы в 34Гб, даже в XML-формате... Вролне возможно, что адресных объектов в базе будет за 100 миллионов. Тем не менее, поисковая система ФНС выдает результат за доли секунды.
3. **Содержание БД не должно быть дорогим**. Понятно, что скорость поиска напрямую зависит от характеристик хоста, на котором развернута БД. Мне не известны на какой машине развернут поисковый сервис адерсов ФНС, но есть задача реализовать БД, удовлетворяющую требования 1,2 на дешевом VDS с минимальными характеристиками.

**Результаты**
VDS _____
Время выполнения запроса на сервере ____
Время выполнения запроса на web-клиенте ____

## Инструкция по созданию и наполнению БД

1. Создаем базу данных для импорта данных

2. Устанавливаем расширение rum-индекс для индектировниа tsvecor-полей (опционально)
``` bash
--- устанвка дополнительного расширения rum индекса (на ubuntu, как на винду не описано)
https://github.com/postgrespro/rum
USE_PGXS=1 pgxn install rum
sudo apt install pgxnclient 
sudo apt install postgresql-12-rum 
create extension rum
```

2. Запускаем SQL-скрипт creator.sql который создает в базе все необходимы таблицы, функции и триггеры
``` bash
psql -d {{dbname}} -f {{path2sctipt}}
```

3. Добавляем в словарь стоп-слов
```bash
/usr/share/postgresql/{{postgres_number}}/tsearch_data/russian.stop
```
дополнительные лексеммы из файла **stopwords.txt**

4. Запускаем скрипт импорта данных **import.py**


**Пример поискового запроса**
``` sql
SELECT fulladdress, fts, for_nominatim, fts <=> websearch_to_tsquery('address','{искомый адрес}') AS rank 
from gar_search2 
where fts @@ websearch_to_tsquery('address','{искомый адрес}')
ORDER BY rank;
```

## Описание таблиц (где что хранится)

## Поисковый запрос
